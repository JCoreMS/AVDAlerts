{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.19.5.34762",
      "templateHash": "4292282244960677608"
    }
  },
  "parameters": {
    "AppGroupName": {
      "type": "string"
    },
    "AppGroupType": {
      "type": "string",
      "allowedValues": [
        "Desktop",
        "RailApplications"
      ]
    },
    "avdOsImage": {
      "type": "string",
      "defaultValue": "win11_22h2",
      "metadata": {
        "description": "Optional. AVD OS image SKU. (Default: win11-21h2)"
      },
      "allowedValues": [
        "win10_21h2",
        "win10_21h2_office",
        "win10_22h2_g2",
        "win10_22h2_office_g2",
        "win11_21h2",
        "win11_21h2_office",
        "win11_22h2",
        "win11_22h2_office"
      ]
    },
    "ComputeGalleryName": {
      "type": "string",
      "defaultValue": ""
    },
    "ComputeGallerySubId": {
      "type": "string",
      "defaultValue": ""
    },
    "ComputeGalleryRG": {
      "type": "string",
      "defaultValue": ""
    },
    "ComputeGalleryImage": {
      "type": "string",
      "defaultValue": ""
    },
    "CustomRdpProperty": {
      "type": "string"
    },
    "DiskSku": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "metadata": {
        "description": "The storage SKU for the AVD session host disks.  Production deployments should use Premium_LRS."
      },
      "allowedValues": [
        "Standard_LRS",
        "StandardSSD_LRS",
        "Premium_LRS"
      ]
    },
    "DomainName": {
      "type": "string"
    },
    "DomainUser": {
      "type": "string"
    },
    "DomainPassword": {
      "type": "securestring"
    },
    "ResourceGroupHP": {
      "type": "string"
    },
    "HostPoolName": {
      "type": "string"
    },
    "HostPoolWorkspaceName": {
      "type": "string",
      "defaultValue": "none"
    },
    "ResourceGroupVMs": {
      "type": "string",
      "defaultValue": ""
    },
    "HostPoolKind": {
      "type": "string",
      "metadata": {
        "description": "These options specify the host pool type and depending on the type provides the load balancing options and assignment types."
      },
      "allowedValues": [
        "Pooled",
        "Personal"
      ]
    },
    "HostPoolLBType": {
      "type": "string",
      "metadata": {
        "description": "These options specify the host pool type and depending on the type provides the load balancing options and assignment types."
      },
      "allowedValues": [
        "DepthFirst",
        "BreadthFirst",
        "Automatic",
        "Direct"
      ]
    },
    "KeyVaultDomainOption": {
      "type": "bool"
    },
    "KeyVaultLocalOption": {
      "type": "bool"
    },
    "KeyVaultDomain": {
      "type": "object",
      "defaultValue": {}
    },
    "KeyVaultLocal": {
      "type": "object",
      "defaultValue": {}
    },
    "KeyVaultDomSecret": {
      "type": "string",
      "defaultValue": ""
    },
    "KeyVaultLocSecret": {
      "type": "string",
      "defaultValue": ""
    },
    "Location": {
      "type": "string",
      "defaultValue": "[deployment().location]"
    },
    "LogAnalyticsWorkspaceName": {
      "type": "string",
      "defaultValue": ""
    },
    "LogAnalyticsSubId": {
      "type": "string"
    },
    "LogAnalyticsRG": {
      "type": "string"
    },
    "NumSessionHosts": {
      "type": "int"
    },
    "NumUsersPerHost": {
      "type": "int"
    },
    "PostDeployEndpoint": {
      "type": "string",
      "defaultValue": ""
    },
    "PostDeployScript": {
      "type": "string"
    },
    "PostDeployStorName": {
      "type": "string"
    },
    "PostDeployStorRG": {
      "type": "string"
    },
    "Restart": {
      "type": "bool",
      "defaultValue": true
    },
    "Subnet": {
      "type": "string"
    },
    "Tags": {
      "type": "object",
      "defaultValue": {}
    },
    "Timestamp": {
      "type": "string",
      "defaultValue": "[utcNow()]"
    },
    "UpdateWindows": {
      "type": "bool"
    },
    "UserIdentityName": {
      "type": "string"
    },
    "StartVmOnConnect": {
      "type": "bool"
    },
    "OUPath": {
      "type": "string"
    },
    "useSharedImage": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Optional. Set to deploy image from Azure Compute Gallery. (Default: false)"
      }
    },
    "VmIndexStart": {
      "type": "int",
      "maxValue": 99
    },
    "VmPrefix": {
      "type": "string",
      "maxLength": 13
    },
    "ValidationEnvironment": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "The value determines whether the hostpool should receive early AVD updates for testing."
      }
    },
    "VirtualNetwork": {
      "type": "string",
      "metadata": {
        "description": "Virtual network for the AVD sessions hosts"
      }
    },
    "VirtualNetworkResourceGroup": {
      "type": "string",
      "metadata": {
        "description": "Virtual network resource group for the AVD sessions hosts"
      }
    },
    "VmPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Local administrator password for the AVD session hosts"
      }
    },
    "VmSize": {
      "type": "string",
      "metadata": {
        "description": "The VM SKU for the AVD session hosts."
      }
    },
    "VmUsername": {
      "type": "string",
      "metadata": {
        "description": "The Local Administrator Username for the Session Hosts"
      }
    }
  },
  "variables": {
    "MaxResourcesPerTemplateDeployment": 79,
    "DivisionValue": "[div(parameters('NumSessionHosts'), variables('MaxResourcesPerTemplateDeployment'))]",
    "DivisionRemainderValue": "[mod(parameters('NumSessionHosts'), variables('MaxResourcesPerTemplateDeployment'))]",
    "SessionHostBatchCount": "[if(greater(variables('DivisionRemainderValue'), 0), add(variables('DivisionValue'), 1), variables('DivisionValue'))]",
    "varAvdAgentPackageLocation": "[format('https://wvdportalstorageblob.blob.{0}/galleryartifacts/Configuration_09-08-2022.zip', environment().suffixes.storage)]",
    "HostPoolType": "[format('{0} {1}', parameters('HostPoolKind'), parameters('HostPoolLBType'))]",
    "DeployVMsTo": "[if(empty(parameters('ResourceGroupVMs')), parameters('ResourceGroupHP'), parameters('ResourceGroupVMs'))]",
    "varKvDomSubId": "[if(parameters('useSharedImage'), 'none', split(parameters('KeyVaultDomain').id, '/')[2])]",
    "varKvLocSubId": "[if(parameters('useSharedImage'), 'none', split(parameters('KeyVaultLocal').id, '/')[2])]",
    "varKvDomRg": "[if(parameters('useSharedImage'), 'none', split(parameters('KeyVaultDomain').id, '/')[4])]",
    "varKvLocRg": "[if(parameters('useSharedImage'), 'none', split(parameters('KeyVaultLocal').id, '/')[4])]",
    "RoleAssignments": {
      "BlobDataRead": {
        "Name": "Blob-Data-Reader",
        "GUID": "2a2b9908-6ea1-4ae2-8e65-a410df84e7d1"
      },
      "ARMRead": {
        "Name": "ARM-Reader",
        "GUID": "acdd72a7-3385-48ef-bd42-f606fba81ae7"
      }
    },
    "varMarketPlaceGalleryWindows": {
      "win10_22h2_g2": {
        "publisher": "MicrosoftWindowsDesktop",
        "offer": "windows-10",
        "sku": "win10-22h2-avd-g2",
        "version": "latest"
      },
      "win10_22h2_office_g2": {
        "publisher": "MicrosoftWindowsDesktop",
        "offer": "office-365",
        "sku": "win10-21h2-avd-m365-g2",
        "version": "latest"
      },
      "win11_21h2": {
        "publisher": "MicrosoftWindowsDesktop",
        "offer": "Windows-11",
        "sku": "win11-21h2-avd",
        "version": "latest"
      },
      "win11_21h2_office": {
        "publisher": "MicrosoftWindowsDesktop",
        "offer": "office-365",
        "sku": "win11-21h2-avd-m365",
        "version": "latest"
      },
      "win11_22h2": {
        "publisher": "MicrosoftWindowsDesktop",
        "offer": "Windows-11",
        "sku": "win11-22h2-avd",
        "version": "latest"
      },
      "win11_22h2_office": {
        "publisher": "MicrosoftWindowsDesktop",
        "offer": "office-365",
        "sku": "win11-22h2-avd-m365",
        "version": "latest"
      },
      "winServer_2022_Datacenter": {
        "publisher": "MicrosoftWindowsServer",
        "offer": "WindowsServer",
        "sku": "2022-datacenter",
        "version": "latest"
      },
      "winServer_2022_datacenter_core": {
        "publisher": "MicrosoftWindowsServer",
        "offer": "WindowsServer",
        "sku": "2022-datacenter-core",
        "version": "latest"
      },
      "winServer_2022_datacenter_azure_edition_core": {
        "publisher": "MicrosoftWindowsServer",
        "offer": "WindowsServer",
        "sku": "2022-datacenter-azure-edition-core",
        "version": "latest"
      },
      "winServer_2022_Datacenter_core_smalldisk_g2": {
        "publisher": "MicrosoftWindowsServer",
        "offer": "WindowsServer",
        "sku": "2022-datacenter-core-smalldisk-g2",
        "version": "latest"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[parameters('ResourceGroupHP')]",
      "location": "[parameters('Location')]"
    },
    {
      "condition": "[not(empty(parameters('ResourceGroupVMs')))]",
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[if(not(empty(parameters('ResourceGroupVMs'))), parameters('ResourceGroupVMs'), 'none')]",
      "location": "[if(not(empty(parameters('Location'))), parameters('Location'), 'none')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "linked_UserIdentityCreateAssign",
      "resourceGroup": "[parameters('ResourceGroupHP')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Location": {
            "value": "[parameters('Location')]"
          },
          "PostDeployStorRG": {
            "value": "[parameters('PostDeployStorRG')]"
          },
          "PostDeployStorName": {
            "value": "[parameters('PostDeployStorName')]"
          },
          "RoleAssignments": {
            "value": "[variables('RoleAssignments')]"
          },
          "UserIdentityName": {
            "value": "[parameters('UserIdentityName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.19.5.34762",
              "templateHash": "14952118657209018171"
            }
          },
          "parameters": {
            "Location": {
              "type": "string"
            },
            "PostDeployStorName": {
              "type": "string"
            },
            "PostDeployStorRG": {
              "type": "string"
            },
            "RoleAssignments": {
              "type": "object"
            },
            "UserIdentityName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2018-11-30",
              "name": "[parameters('UserIdentityName')]",
              "location": "[parameters('Location')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "linked_assignUserIDRole",
              "resourceGroup": "[parameters('PostDeployStorRG')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "PostDeployStorName": {
                    "value": "[parameters('PostDeployStorName')]"
                  },
                  "UserIdentityName": {
                    "value": "[parameters('UserIdentityName')]"
                  },
                  "RoleAssignments": {
                    "value": "[parameters('RoleAssignments')]"
                  },
                  "UserIdentityPrincipalId": {
                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('UserIdentityName')), '2018-11-30').principalId]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.19.5.34762",
                      "templateHash": "10495951730458244041"
                    }
                  },
                  "parameters": {
                    "PostDeployStorName": {
                      "type": "string"
                    },
                    "RoleAssignments": {
                      "type": "object"
                    },
                    "UserIdentityName": {
                      "type": "string"
                    },
                    "UserIdentityPrincipalId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "roleAssignment",
                        "count": "[length(items(parameters('RoleAssignments')))]"
                      },
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('PostDeployStorName'))]",
                      "name": "[guid(subscription().id, parameters('UserIdentityPrincipalId'), items(parameters('RoleAssignments'))[copyIndex()].value.GUID)]",
                      "properties": {
                        "description": "[format('Provides User Identity {0} read access for post deployment scripts.', parameters('UserIdentityName'))]",
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', items(parameters('RoleAssignments'))[copyIndex()].value.GUID)]",
                        "principalId": "[parameters('UserIdentityPrincipalId')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('UserIdentityName'))]"
              ]
            }
          ],
          "outputs": {
            "userIdentityResId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('UserIdentityName'))]"
            },
            "userIdentityObjId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('UserIdentityName')), '2018-11-30').principalId]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "linked_logAnalyticsWorkspace",
      "subscriptionId": "[parameters('LogAnalyticsSubId')]",
      "resourceGroup": "[parameters('LogAnalyticsRG')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "LogAnalyticsWorkspaceName": {
            "value": "[parameters('LogAnalyticsWorkspaceName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.19.5.34762",
              "templateHash": "4675345650375706925"
            }
          },
          "parameters": {
            "LogAnalyticsWorkspaceName": {
              "type": "string"
            }
          },
          "resources": [],
          "outputs": {
            "logAnalyticsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('LogAnalyticsWorkspaceName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "linked_HostPoolDeployment",
      "resourceGroup": "[parameters('ResourceGroupHP')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AppGroupName": {
            "value": "[parameters('AppGroupName')]"
          },
          "AppGroupType": {
            "value": "[parameters('AppGroupType')]"
          },
          "ComputeGalleryImageId": {
            "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('ComputeGallerySubId'), parameters('ComputeGalleryRG')), 'Microsoft.Compute/galleries/images', split(format('{0}/{1}', parameters('ComputeGalleryName'), parameters('ComputeGalleryImage')), '/')[0], split(format('{0}/{1}', parameters('ComputeGalleryName'), parameters('ComputeGalleryImage')), '/')[1])]"
          },
          "CustomRdpProperty": {
            "value": "[parameters('CustomRdpProperty')]"
          },
          "DiskSku": {
            "value": "[parameters('DiskSku')]"
          },
          "DomainName": {
            "value": "[parameters('DomainName')]"
          },
          "HostPoolName": {
            "value": "[parameters('HostPoolName')]"
          },
          "HostPoolType": {
            "value": "[variables('HostPoolType')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "NumUsersPerHost": {
            "value": "[parameters('NumUsersPerHost')]"
          },
          "StartVmOnConnect": {
            "value": "[parameters('StartVmOnConnect')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "ValidationEnvironment": {
            "value": "[parameters('ValidationEnvironment')]"
          },
          "VmPrefix": {
            "value": "[parameters('VmPrefix')]"
          },
          "VmSize": {
            "value": "[parameters('VmSize')]"
          },
          "HostPoolWorkspaceName": {
            "value": "[parameters('HostPoolWorkspaceName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.19.5.34762",
              "templateHash": "16324101705218575869"
            }
          },
          "parameters": {
            "AppGroupName": {
              "type": "string"
            },
            "AppGroupType": {
              "type": "string"
            },
            "CustomRdpProperty": {
              "type": "string"
            },
            "DiskSku": {
              "type": "string"
            },
            "DomainName": {
              "type": "string"
            },
            "HostPoolName": {
              "type": "string"
            },
            "HostPoolType": {
              "type": "string"
            },
            "HostPoolWorkspaceName": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "NumUsersPerHost": {
              "type": "int"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string",
              "defaultValue": "[utcNow('u')]"
            },
            "StartVmOnConnect": {
              "type": "bool"
            },
            "ComputeGalleryImageId": {
              "type": "string"
            },
            "VmPrefix": {
              "type": "string"
            },
            "ValidationEnvironment": {
              "type": "bool"
            },
            "VmSize": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.DesktopVirtualization/hostPools",
              "apiVersion": "2022-04-01-preview",
              "name": "[parameters('HostPoolName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "hostPoolType": "[split(parameters('HostPoolType'), ' ')[0]]",
                "maxSessionLimit": "[parameters('NumUsersPerHost')]",
                "loadBalancerType": "[if(contains(parameters('HostPoolType'), 'Pooled'), split(parameters('HostPoolType'), ' ')[1], 'Persistent')]",
                "validationEnvironment": "[parameters('ValidationEnvironment')]",
                "registrationInfo": {
                  "expirationTime": "[dateTimeAdd(parameters('Timestamp'), 'PT2H')]",
                  "registrationTokenOperation": "Update"
                },
                "preferredAppGroupType": "[parameters('AppGroupType')]",
                "customRdpProperty": "[parameters('CustomRdpProperty')]",
                "personalDesktopAssignmentType": "[if(contains(parameters('HostPoolType'), 'Personal'), split(parameters('HostPoolType'), ' ')[1], null())]",
                "startVMOnConnect": "[parameters('StartVmOnConnect')]",
                "vmTemplate": "[format('{{\"domain\":\"{0}\",\"galleryImageOffer\":null,\"galleryImagePublisher\":null,\"galleryImageSKU\":null,\"imageType\":\"CustomImage\",\"imageUri\":null,\"customImageId\":\"{1}\",\"namePrefix\":\"{2}\",\"osDiskType\":\"{3}\",\"useManagedDisks\":true,\"vmSize\":{{\"id\":\"{4}\",\"cores\":null,\"ram\":null}},\"galleryItemId\":null}}', parameters('DomainName'), parameters('ComputeGalleryImageId'), parameters('VmPrefix'), parameters('DiskSku'), parameters('VmSize'))]"
              }
            },
            {
              "type": "Microsoft.DesktopVirtualization/applicationGroups",
              "apiVersion": "2022-04-01-preview",
              "name": "[parameters('AppGroupName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "hostPoolArmPath": "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('HostPoolName'))]",
                "applicationGroupType": "Desktop"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('HostPoolName'))]"
              ]
            },
            {
              "condition": "[not(equals(parameters('HostPoolWorkspaceName'), 'none'))]",
              "type": "Microsoft.DesktopVirtualization/workspaces",
              "apiVersion": "2022-04-01-preview",
              "name": "[parameters('HostPoolWorkspaceName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "applicationGroupReferences": [
                  "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('AppGroupName'))]"
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('AppGroupName'))]",
                "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('HostPoolName'))]"
              ]
            }
          ],
          "outputs": {
            "HostPoolRegistrationToken": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('HostPoolName'))).registrationInfo.token]"
            },
            "ComputeImageGalleryID": {
              "type": "string",
              "value": "[parameters('ComputeGalleryImageId')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('ResourceGroupHP'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "linked_Monitoring_Setup",
      "resourceGroup": "[parameters('ResourceGroupHP')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "HostPoolName": {
            "value": "[parameters('HostPoolName')]"
          },
          "LogAnalyticsWorkspaceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('LogAnalyticsSubId'), parameters('LogAnalyticsRG')), 'Microsoft.Resources/deployments', 'linked_logAnalyticsWorkspace'), '2022-09-01').outputs.logAnalyticsId.value]"
          },
          "HostPoolWorkspaceName": {
            "value": "[parameters('HostPoolWorkspaceName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.19.5.34762",
              "templateHash": "5177707212109496032"
            }
          },
          "parameters": {
            "HostPoolName": {
              "type": "string"
            },
            "LogAnalyticsWorkspaceId": {
              "type": "string"
            },
            "HostPoolWorkspaceName": {
              "type": "string"
            }
          },
          "variables": {
            "HostPoolLogs": [
              {
                "category": "Checkpoint",
                "enabled": true
              },
              {
                "category": "Error",
                "enabled": true
              },
              {
                "category": "Management",
                "enabled": true
              },
              {
                "category": "Connection",
                "enabled": true
              },
              {
                "category": "HostRegistration",
                "enabled": true
              },
              {
                "category": "AgentHealthStatus",
                "enabled": true
              },
              {
                "category": "ConnectionGraphicsData",
                "enabled": true
              }
            ]
          },
          "resources": [
            {
              "condition": "[not(equals(parameters('HostPoolWorkspaceName'), 'none'))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2017-05-01-preview",
              "scope": "[format('Microsoft.DesktopVirtualization/workspaces/{0}', parameters('HostPoolWorkspaceName'))]",
              "name": "WVDInsights",
              "properties": {
                "logs": [
                  {
                    "category": "Checkpoint",
                    "enabled": true
                  },
                  {
                    "category": "Error",
                    "enabled": true
                  },
                  {
                    "category": "Management",
                    "enabled": true
                  },
                  {
                    "category": "Feed",
                    "enabled": true
                  }
                ],
                "workspaceId": "[parameters('LogAnalyticsWorkspaceId')]"
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.DesktopVirtualization/hostPools/{0}', parameters('HostPoolName'))]",
              "name": "WVDInsights",
              "properties": {
                "logs": "[variables('HostPoolLogs')]",
                "workspaceId": "[parameters('LogAnalyticsWorkspaceId')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroupHP')), 'Microsoft.Resources/deployments', 'linked_HostPoolDeployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('LogAnalyticsSubId'), parameters('LogAnalyticsRG')), 'Microsoft.Resources/deployments', 'linked_logAnalyticsWorkspace')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('ResourceGroupHP'))]"
      ]
    },
    {
      "copy": {
        "name": "virtualMachines",
        "count": "[length(range(1, variables('SessionHostBatchCount')))]",
        "mode": "serial",
        "batchSize": 1
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('linked_VirtualMachines_{0}_{1}', sub(range(1, variables('SessionHostBatchCount'))[copyIndex()], 1), guid(parameters('Timestamp')))]",
      "resourceGroup": "[variables('DeployVMsTo')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AgentPackageLocation": {
            "value": "[variables('varAvdAgentPackageLocation')]"
          },
          "ComputeGalleryImageId": "[if(parameters('useSharedImage'), createObject('value', format('{0}/versions/latest', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('ComputeGallerySubId'), parameters('ComputeGalleryRG')), 'Microsoft.Compute/galleries/images', split(format('{0}/{1}', parameters('ComputeGalleryName'), parameters('ComputeGalleryImage')), '/')[0], split(format('{0}/{1}', parameters('ComputeGalleryName'), parameters('ComputeGalleryImage')), '/')[1]))), createObject('value', 'none'))]",
          "ComputeGalleryProperties": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('ComputeGallerySubId'), parameters('ComputeGalleryRG')), 'Microsoft.Compute/galleries/images', split(format('{0}/{1}', parameters('ComputeGalleryName'), parameters('ComputeGalleryImage')), '/')[0], split(format('{0}/{1}', parameters('ComputeGalleryName'), parameters('ComputeGalleryImage')), '/')[1]), '2022-03-03')]"
          },
          "DomainUser": {
            "value": "[parameters('DomainUser')]"
          },
          "DomainPassword": "[if(parameters('KeyVaultDomainOption'), createObject('reference', createObject('keyVault', createObject('id', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('varKvDomSubId'), variables('varKvDomRg')), 'Microsoft.KeyVault/vaults', parameters('KeyVaultDomain').Name)), 'secretName', parameters('KeyVaultDomSecret'))), createObject('value', parameters('DomainPassword')))]",
          "DomainName": {
            "value": "[parameters('DomainName')]"
          },
          "HostPoolName": {
            "value": "[parameters('HostPoolName')]"
          },
          "HostPoolRegistrationToken": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroupHP')), 'Microsoft.Resources/deployments', 'linked_HostPoolDeployment'), '2022-09-01').outputs.HostPoolRegistrationToken.value]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "LogAnalyticsWorkspaceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('LogAnalyticsSubId'), parameters('LogAnalyticsRG')), 'Microsoft.Resources/deployments', 'linked_logAnalyticsWorkspace'), '2022-09-01').outputs.logAnalyticsId.value]"
          },
          "NumSessionHosts": {
            "value": "[parameters('NumSessionHosts')]"
          },
          "MarketPlaceGalleryWindows": "[if(not(parameters('useSharedImage')), createObject('value', variables('varMarketPlaceGalleryWindows')[parameters('avdOsImage')]), createObject('value', createObject()))]",
          "OUPath": {
            "value": "[parameters('OUPath')]"
          },
          "PostDeployEndpoint": {
            "value": "[parameters('PostDeployEndpoint')]"
          },
          "PostDeployScript": {
            "value": "[parameters('PostDeployScript')]"
          },
          "Restart": {
            "value": "[parameters('Restart')]"
          },
          "Subnet": {
            "value": "[parameters('Subnet')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          },
          "UpdateWindows": {
            "value": "[parameters('UpdateWindows')]"
          },
          "useSharedImage": {
            "value": "[parameters('useSharedImage')]"
          },
          "UserIdentityResId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroupHP')), 'Microsoft.Resources/deployments', 'linked_UserIdentityCreateAssign'), '2022-09-01').outputs.userIdentityResId.value]"
          },
          "UserIdentityObjId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroupHP')), 'Microsoft.Resources/deployments', 'linked_UserIdentityCreateAssign'), '2022-09-01').outputs.userIdentityObjId.value]"
          },
          "VirtualNetwork": {
            "value": "[parameters('VirtualNetwork')]"
          },
          "VirtualNetworkResourceGroup": {
            "value": "[parameters('VirtualNetworkResourceGroup')]"
          },
          "VmIndexStart": {
            "value": "[parameters('VmIndexStart')]"
          },
          "VmSize": {
            "value": "[parameters('VmSize')]"
          },
          "VmUsername": {
            "value": "[parameters('VmUsername')]"
          },
          "VmPassword": "[if(parameters('KeyVaultLocalOption'), createObject('reference', createObject('keyVault', createObject('id', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('varKvLocSubId'), variables('varKvLocRg')), 'Microsoft.KeyVault/vaults', parameters('KeyVaultLocal').Name)), 'secretName', parameters('KeyVaultLocSecret'))), createObject('value', parameters('VmPassword')))]",
          "VmPrefix": {
            "value": "[parameters('VmPrefix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.19.5.34762",
              "templateHash": "7879869805052922451"
            }
          },
          "parameters": {
            "AgentPackageLocation": {
              "type": "string"
            },
            "ComputeGalleryImageId": {
              "type": "string"
            },
            "ComputeGalleryProperties": {
              "type": "object"
            },
            "DomainName": {
              "type": "securestring"
            },
            "DomainUser": {
              "type": "string"
            },
            "DomainPassword": {
              "type": "securestring"
            },
            "HostPoolName": {
              "type": "string"
            },
            "HostPoolRegistrationToken": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "LogAnalyticsWorkspaceId": {
              "type": "string"
            },
            "NumSessionHosts": {
              "type": "int"
            },
            "MarketPlaceGalleryWindows": {
              "type": "object",
              "metadata": {
                "description": "Market Place OS image."
              }
            },
            "PostDeployEndpoint": {
              "type": "string"
            },
            "PostDeployScript": {
              "type": "string"
            },
            "Restart": {
              "type": "bool"
            },
            "Subnet": {
              "type": "string"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string"
            },
            "UpdateWindows": {
              "type": "bool"
            },
            "useSharedImage": {
              "type": "bool",
              "metadata": {
                "description": "Optional. Set to deploy image from Azure Compute Gallery. (Default: false)"
              }
            },
            "UserIdentityResId": {
              "type": "string"
            },
            "UserIdentityObjId": {
              "type": "string"
            },
            "OUPath": {
              "type": "string"
            },
            "VirtualNetwork": {
              "type": "string"
            },
            "VirtualNetworkResourceGroup": {
              "type": "string"
            },
            "VmIndexStart": {
              "type": "int"
            },
            "VmPrefix": {
              "type": "string"
            },
            "VmSize": {
              "type": "string"
            },
            "VmUsername": {
              "type": "string"
            },
            "VmPassword": {
              "type": "securestring"
            }
          },
          "variables": {
            "HyperVGen": "[parameters('ComputeGalleryProperties').hyperVGeneration]",
            "Architecture": "[parameters('ComputeGalleryProperties').architecture]",
            "SecurityType": "[if(contains(parameters('ComputeGalleryProperties'), 'features'), filter(parameters('ComputeGalleryProperties').features, lambda('feature', equals(lambdaVariables('feature').name, 'SecurityType')))[0].value, 'TrustedLaunch')]",
            "securityProfileJson": {
              "uefiSettings": {
                "secureBootEnabled": true,
                "vTpmEnabled": true
              },
              "securityType": "[variables('SecurityType')]"
            },
            "imageToUse": "[if(parameters('useSharedImage'), createObject('id', parameters('ComputeGalleryImageId')), parameters('MarketPlaceGalleryWindows'))]"
          },
          "resources": [
            {
              "copy": {
                "name": "networkInterface",
                "count": "[length(range(0, parameters('NumSessionHosts')))]"
              },
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2022-11-01",
              "name": "[format('nic-{0}{1}', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0'))]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[resourceId(subscription().subscriptionId, parameters('VirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks/subnets', parameters('VirtualNetwork'), parameters('Subnet'))]"
                      },
                      "primary": true,
                      "privateIPAddressVersion": "IPv4"
                    }
                  }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false
              }
            },
            {
              "copy": {
                "name": "virtualMachine",
                "count": "[length(range(0, parameters('NumSessionHosts')))]"
              },
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2022-11-01",
              "name": "[format('{0}{1}', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0'))]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('UserIdentityResId'))]": {}
                }
              },
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('VmSize')]"
                },
                "storageProfile": {
                  "imageReference": "[variables('imageToUse')]",
                  "osDisk": {
                    "name": "[format('osDisk-{0}{1}', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0'))]",
                    "osType": "Windows",
                    "createOption": "FromImage",
                    "caching": "ReadOnly",
                    "deleteOption": "Delete"
                  },
                  "dataDisks": []
                },
                "osProfile": {
                  "computerName": "[format('{0}{1}', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0'))]",
                  "adminUsername": "[parameters('VmUsername')]",
                  "adminPassword": "[parameters('VmPassword')]",
                  "windowsConfiguration": {
                    "provisionVMAgent": true,
                    "enableAutomaticUpdates": false
                  },
                  "secrets": [],
                  "allowExtensionOperations": true
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}{1}', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0')))]",
                      "properties": {
                        "deleteOption": "Delete"
                      }
                    }
                  ]
                },
                "securityProfile": "[if(equals(variables('SecurityType'), 'TrustedLaunch'), variables('securityProfileJson'), null())]",
                "diagnosticsProfile": {
                  "bootDiagnostics": {
                    "enabled": false
                  }
                },
                "licenseType": "Windows_Client"
              },
              "dependsOn": [
                "networkInterface"
              ]
            },
            {
              "copy": {
                "name": "extension_MicrosoftMonitoringAgent",
                "count": "[length(range(0, parameters('NumSessionHosts')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}{1}/MicrosoftMonitoringAgent', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0'))]",
              "location": "[parameters('Location')]",
              "properties": {
                "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                "type": "MicrosoftMonitoringAgent",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "workspaceId": "[reference(parameters('LogAnalyticsWorkspaceId'), '2015-03-20').customerId]"
                },
                "protectedSettings": {
                  "workspaceKey": "[listKeys(parameters('LogAnalyticsWorkspaceId'), '2015-03-20').primarySharedKey]"
                }
              },
              "dependsOn": [
                "virtualMachine"
              ]
            },
            {
              "copy": {
                "name": "extension_JsonADDomainExtension",
                "count": "[length(range(0, parameters('NumSessionHosts')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}{1}/JsonADDomainExtension', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0'))]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "forceUpdateTag": "[parameters('Timestamp')]",
                "publisher": "Microsoft.Compute",
                "type": "JsonADDomainExtension",
                "typeHandlerVersion": "1.3",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "Name": "[parameters('DomainName')]",
                  "User": "[parameters('DomainUser')]",
                  "Restart": "true",
                  "Options": "3",
                  "OUPath": "[parameters('OUPath')]"
                },
                "protectedSettings": {
                  "Password": "[parameters('DomainPassword')]"
                }
              },
              "dependsOn": [
                "extension_MicrosoftMonitoringAgent"
              ]
            },
            {
              "copy": {
                "name": "addToHostPool",
                "count": "[length(range(0, parameters('NumSessionHosts')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}{1}/HostPoolRegistration', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0'))]",
              "location": "[parameters('Location')]",
              "properties": {
                "publisher": "Microsoft.PowerShell",
                "type": "DSC",
                "typeHandlerVersion": "2.73",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "modulesUrl": "[parameters('AgentPackageLocation')]",
                  "configurationFunction": "Configuration.ps1\\AddSessionHost",
                  "properties": {
                    "hostPoolName": "[parameters('HostPoolName')]",
                    "registrationInfoToken": "[parameters('HostPoolRegistrationToken')]",
                    "aadJoin": false
                  }
                }
              },
              "dependsOn": [
                "extension_JsonADDomainExtension"
              ]
            },
            {
              "copy": {
                "name": "extension_CustomScriptExtension",
                "count": "[length(range(0, parameters('NumSessionHosts')))]"
              },
              "condition": "[not(empty(parameters('PostDeployEndpoint')))]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2023-03-01",
              "name": "[format('{0}{1}/CustomScriptExtension', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0'))]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "publisher": "Microsoft.Compute",
                "type": "CustomScriptExtension",
                "typeHandlerVersion": "1.10",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "fileUris": [
                    "[format('{0}{1}', parameters('PostDeployEndpoint'), parameters('PostDeployScript'))]"
                  ],
                  "timestamp": "[parameters('Timestamp')]"
                },
                "protectedSettings": {
                  "managedIdentity": {
                    "objectId": "[parameters('UserIdentityObjId')]"
                  },
                  "commandToExecute": "[format('powershell -ExecutionPolicy Unrestricted -File {0} -WindowsUpdate {1} -Restart {2}', parameters('PostDeployScript'), parameters('UpdateWindows'), parameters('Restart'))]"
                }
              },
              "dependsOn": [
                "addToHostPool"
              ]
            }
          ],
          "outputs": {
            "RegistrationToken": {
              "type": "string",
              "value": "[parameters('HostPoolRegistrationToken')]"
            },
            "HyperVGen": {
              "type": "string",
              "value": "[variables('HyperVGen')]"
            },
            "Architecture": {
              "type": "string",
              "value": "[variables('Architecture')]"
            },
            "ComputeGalProp": {
              "type": "object",
              "value": "[parameters('ComputeGalleryProperties')]"
            },
            "useSharedImage": {
              "type": "bool",
              "value": "[parameters('useSharedImage')]"
            },
            "ComputeGalleryImageId": {
              "type": "string",
              "value": "[parameters('ComputeGalleryImageId')]"
            },
            "marketPlaceGalleryWindows": {
              "type": "object",
              "value": "[parameters('MarketPlaceGalleryWindows')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroupHP')), 'Microsoft.Resources/deployments', 'linked_HostPoolDeployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('LogAnalyticsSubId'), parameters('LogAnalyticsRG')), 'Microsoft.Resources/deployments', 'linked_logAnalyticsWorkspace')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroupHP')), 'Microsoft.Resources/deployments', 'linked_UserIdentityCreateAssign')]"
      ]
    }
  ]
}
