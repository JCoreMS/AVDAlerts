{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.7.4.23292",
      "templateHash": "10195536134382698317"
    }
  },
  "parameters": {
    "DistributionGroup": {
      "type": "string",
      "defaultValue": "jamasten@microsoft.com",
      "metadata": {
        "description": "The Distribution Group that will receive email alerts for AVD."
      }
    },
    "Environment": {
      "type": "string",
      "defaultValue": "d",
      "metadata": {
        "description": "The environment is which these resources will be deployed, i.e. Development."
      },
      "allowedValues": [
        "d",
        "p",
        "t"
      ]
    },
    "Location": {
      "type": "string",
      "defaultValue": "[deployment().location]",
      "metadata": {
        "description": "Azure Region for Resources"
      }
    },
    "LogAnalyticsWorkspaceResourceId": {
      "type": "string",
      "defaultValue": "law-eastus2-avdlab",
      "metadata": {
        "description": "The Resource ID for the Log Analytics Workspace."
      }
    },
    "ScriptsRepositorySasToken": {
      "type": "secureString",
      "defaultValue": "",
      "metadata": {
        "description": "The SAS token if using a storage account for the repository."
      }
    },
    "ScriptsRepositoryUri": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The repository URI hosting the scripts for this solution."
      }
    },
    "SessionHostsResourceGroupIds": {
      "type": "array",
      "defaultValue": [
        "/subscriptions/8a0ecebc-0e1d-4e8f-8cb8-8a92f49455b9/resourceGroups/rg-eastus2-AVDLab-Resources"
      ],
      "metadata": {
        "description": "The Resource Group ID for the AVD session hosts."
      }
    },
    "StorageAccountResourceIds": {
      "type": "array",
      "defaultValue": [
        "/subscriptions/8a0ecebc-0e1d-4e8f-8cb8-8a92f49455b9/resourceGroups/rg-eastus2-AVDLab-Resources/providers/Microsoft.Storage/storageAccounts/storavdlabeus2"
      ],
      "metadata": {
        "description": "The Resource IDs for the Storage Accounts or NetApp Account used for FSLogix profile storage."
      }
    },
    "Timestamp": {
      "type": "string",
      "defaultValue": "[utcNow('yyyyMMddhhmmss')]"
    },
    "Tags": {
      "type": "object",
      "defaultValue": {}
    }
  },
  "variables": {
    "AutomationAccountName": "[format('aa-avdmetrics-{0}-{1}', parameters('Environment'), parameters('Location'))]",
    "ActionGroupName": "[format('ag-avdmetrics-{0}-{1}', parameters('Environment'), parameters('Location'))]",
    "LogicAppName": "[format('la-avdmetrics-{0}-{1}', parameters('Environment'), parameters('Location'))]",
    "ResourceGroupName": "[format('rg-avdmetrics-{0}-{1}', parameters('Environment'), parameters('Location'))]",
    "RoleName": "Log Analytics Workspace Metrics Contributor",
    "RoleDescription": "This role allows a resource to write to Log Analytics Metrics.",
    "RunbookName": "AvdLogGenerator",
    "RunbookScript": "Get-AzureAvdLogs.ps1",
    "LogAlerts": [
      {
        "name": "AVD-HostPool-No Resources Available",
        "displayName": "AVD-HostPool-No Resources Available",
        "severity": 1,
        "evaluationFrequency": "PT1H",
        "windowSize": "PT1H",
        "criteria": {
          "allOf": [
            {
              "query": "WVDConnections \n| where TimeGenerated > ago (1h) \n| project-away TenantId,SourceSystem  \n| summarize arg_max(TimeGenerated, *), StartTime =  min(iff(State== 'Started', TimeGenerated , datetime(null) )), ConnectTime = min(iff(State== 'Connected', TimeGenerated , datetime(null) ))   by CorrelationId  \n| join kind=leftouter (WVDErrors\n    |summarize Errors=makelist(pack('Code', Code, 'CodeSymbolic', CodeSymbolic, 'Time', TimeGenerated, 'Message', Message ,'ServiceError', ServiceError, 'Source', Source)) by CorrelationId  \n    ) on CorrelationId\n| join kind=leftouter (WVDCheckpoints\n    | summarize Checkpoints=makelist(pack('Time', TimeGenerated, 'Name', Name, 'Parameters', Parameters, 'Source', Source)) by CorrelationId  \n    | mv-apply Checkpoints on (  \n        order by todatetime(Checkpoints['Time']) asc\n        | summarize Checkpoints=makelist(Checkpoints)\n        )\n    ) on CorrelationId  \n| project-away CorrelationId1, CorrelationId2  \n| order by TimeGenerated desc\n| where Errors[0].CodeSymbolic == \"ConnectionFailedNoHealthyRdshAvailable\"\n\n",
              "timeAggregation": "Count",
              "dimensions": [
                {
                  "name": "UserName",
                  "operator": "Include",
                  "values": [
                    "*"
                  ]
                },
                {
                  "name": "SessionHostName",
                  "operator": "Include",
                  "values": [
                    "*"
                  ]
                }
              ],
              "resourceIdColumn": "_ResourceId",
              "operator": "GreaterThanOrEqual",
              "threshold": 1,
              "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
              }
            }
          ]
        }
      },
      {
        "name": "AVD-VM-Local Disk Free Space Warning 90 Percent",
        "displayName": "AVD-VM-Local Disk Free Space Warning 90 Percent",
        "severity": 2,
        "evaluationFrequency": "PT15M",
        "windowSize": "PT15M",
        "criteria": {
          "allOf": [
            {
              "query": "InsightsMetrics\n| where Origin == \"vm.azm.ms\"\n| where Namespace == \"LogicalDisk\" and Name == \"FreeSpacePercentage\"\n| summarize AggregatedValue = avg(Val) by bin(TimeGenerated, 15m), Computer, _ResourceId\n",
              "timeAggregation": "Average",
              "metricMeasureColumn": "AggregatedValue",
              "dimensions": [],
              "resourceIdColumn": "_ResourceId",
              "operator": "LessThan",
              "threshold": 10,
              "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
              }
            }
          ]
        }
      },
      {
        "name": "AVD-VM-FSLogix Profile Failed",
        "displayName": "AVD-VM-FSLogix Profile Failed (Event Log Indicated Failure)",
        "severity": 1,
        "evaluationFrequency": "PT5M",
        "windowSize": "PT5M",
        "criteria": {
          "allOf": [
            {
              "query": "Event\n| where EventLog == \"Microsoft-FSLogix-Apps/Admin\"\n| where EventLevelName == \"Error\"\n\n",
              "timeAggregation": "Count",
              "dimensions": [
                {
                  "name": "Computer",
                  "operator": "Include",
                  "values": [
                    "*"
                  ]
                },
                {
                  "name": "RenderedDescription",
                  "operator": "Include",
                  "values": [
                    "*"
                  ]
                }
              ],
              "operator": "GreaterThanOrEqual",
              "threshold": 1,
              "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
              }
            }
          ]
        }
      },
      {
        "name": "AVD-VM-Local Disk Free Space Warning 95 Percent",
        "displayName": "AVD-VM-Local Disk Free Space Warning 95 Percent",
        "severity": 1,
        "evaluationFrequency": "PT15M",
        "windowSize": "PT15M",
        "criteria": {
          "allOf": [
            {
              "query": "InsightsMetrics\n| where Origin == \"vm.azm.ms\"\n| where Namespace == \"LogicalDisk\" and Name == \"FreeSpacePercentage\"\n| summarize AggregatedValue = avg(Val) by bin(TimeGenerated, 15m), Computer, _ResourceId\n",
              "timeAggregation": "Average",
              "metricMeasureColumn": "AggregatedValue",
              "dimensions": [],
              "resourceIdColumn": "_ResourceId",
              "operator": "LessThan",
              "threshold": 5,
              "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
              }
            }
          ]
        }
      },
      {
        "name": "AVD-VM-Health Check Failure",
        "displayName": "AVD-VM-Health Check Failure",
        "description": "VM is available for use but one of the dependent resources is in a failed state",
        "severity": 1,
        "evaluationFrequency": "PT5M",
        "windowSize": "PT5M",
        "overrideQueryTimeRange": "P2D",
        "criteria": {
          "allOf": [
            {
              "query": "// HealthChecks of SessionHost \n// Renders a summary of SessionHost health status. \nlet MapToDesc = (idx:long) {\n    case(idx == 0,  \"DomainJoin\",\n         idx == 1,  \"DomainTrust\",\n         idx == 2,  \"FSLogix\",\n         idx == 3,  \"SxSStack\",\n         idx == 4,  \"URLCheck\",\n         idx == 5,  \"GenevaAgent\",\n         idx == 6,  \"DomainReachable\",\n         idx == 7,  \"WebRTCRedirector\",\n         idx == 8,  \"SxSStackEncryption\",\n         idx == 9,  \"IMDSReachable\",\n         idx == 10, \"MSIXPackageStaging\",\n         \"InvalidIndex\")\n};\nWVDAgentHealthStatus\n| where TimeGenerated > ago(10m)\n| where Status != 'Available'\n| where AllowNewSessions = True\n| extend CheckFailed = parse_json(SessionHostHealthCheckResult)\n| mv-expand CheckFailed\n| where CheckFailed.AdditionalFailureDetails.ErrorCode != 0\n| extend HealthCheckName = tolong(CheckFailed.HealthCheckName)\n| extend HealthCheckResult = tolong(CheckFailed.HealthCheckResult)\n| extend HealthCheckDesc = MapToDesc(HealthCheckName)\n\n",
              "timeAggregation": "Count",
              "dimensions": [
                {
                  "name": "SessionHostName",
                  "operator": "Include",
                  "values": [
                    "*"
                  ]
                }
              ],
              "operator": "GreaterThanOrEqual",
              "threshold": 1,
              "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
              }
            }
          ]
        }
      },
      {
        "name": "AVD-Storage-Low Space on File Share-15 Percent Remaining",
        "displayName": "AVD-Storage-Low Space on File Share-15 Percent Remaining",
        "description": "This alert is based on the Action Account and Runbook that populates the Log Analytics specificed with the AVD Metrics Deployment Solution.\n-->Last Number in the string is the Percentage Remaining for the Share.\nOutput: ResultsDescription\nStorageType,Subscription,ResourceGroup,StorageAccount,ShareName,Quota,GBUsed,PercentRemaining",
        "severity": 2,
        "evaluationFrequency": "PT10M",
        "windowSize": "PT10M",
        "overrideQueryTimeRange": "P2D",
        "criteria": {
          "allOf": [
            {
              "query": "          AzureDiagnostics \r\n          | where Category has \"JobStreams\"\r\n          | where StreamType_s has \"Output\"\r\n          | sort by TimeGenerated\r\n          //  StorageType / Subscription / RG / StorAcct / Share / Quota / GB Used / %Available\r\n          | extend StorageType=split(ResultDescription, ',')[0]\r\n          | extend Subscription=split(ResultDescription, ',')[1]\r\n          | extend ResourceGroup=split(ResultDescription, ',')[2]\r\n          | extend StorageAccount=split(ResultDescription, ',')[3]\r\n          | extend Share=split(ResultDescription, ',')[4]\r\n          | extend GBShareQuota=split(ResultDescription, ',')[5]\r\n          | extend GBUsed=split(ResultDescription, ',')[6]\r\n          | extend PercentAvailable=split(ResultDescription, ',')[7]\r\n          | where PercentAvailable <= 15.00 and PercentAvailable < 5.00          \r\n           ",
              "timeAggregation": "Count",
              "dimensions": [
                {
                  "name": "ResultDescription",
                  "operator": "Include",
                  "values": [
                    "*"
                  ]
                }
              ],
              "resourceIdColumng": "_ResourceId",
              "operator": "GreaterThanOrEqual",
              "threshold": 1,
              "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
              }
            }
          ]
        }
      },
      {
        "name": "AVD-Storage-Low Space on File Share-5 Percent Remaining",
        "displayName": "AVD-Storage-Low Space on File Share-5 Percent Remaining",
        "description": "This alert is based on the Action Account and Runbook that populates the Log Analytics specificed with the AVD Metrics Deployment Solution.\n-->Last Number in the string is the Percentage Remaining for the Share.\nOutput: ResultsDescription\nStorageType,Subscription,ResourceGroup,StorageAccount,ShareName,Quota,GBUsed,PercentRemaining",
        "severity": 1,
        "evaluationFrequency": "PT10M",
        "windowSize": "PT10M",
        "overrideQueryTimeRange": "P2D",
        "criteria": {
          "allOf": [
            {
              "query": "          AzureDiagnostics \r\n          | where Category has \"JobStreams\"\r\n          | where StreamType_s has \"Output\"\r\n          | sort by TimeGenerated\r\n          //  StorageType / Subscription / RG / StorAcct / Share / Quota / GB Used / %Available\r\n          | extend StorageType=split(ResultDescription, ',')[0]\r\n          | extend Subscription=split(ResultDescription, ',')[1]\r\n          | extend ResourceGroup=split(ResultDescription, ',')[2]\r\n          | extend StorageAccount=split(ResultDescription, ',')[3]\r\n          | extend Share=split(ResultDescription, ',')[4]\r\n          | extend GBShareQuota=split(ResultDescription, ',')[5]\r\n          | extend GBUsed=split(ResultDescription, ',')[6]\r\n          | extend PercentAvailable=split(ResultDescription, ',')[7]\r\n          | where PercentAvailable <= 5.00          \r\n           ",
              "timeAggregation": "Count",
              "dimensions": [
                {
                  "name": "ResultDescription",
                  "operator": "Include",
                  "values": [
                    "*"
                  ]
                }
              ],
              "resourceIdColumng": "_ResourceId",
              "operator": "GreaterThanOrEqual",
              "threshold": 1,
              "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
              }
            }
          ]
        }
      }
    ],
    "MetricAlerts": {
      "storageAccounts": [
        {
          "name": "AVD-Storage-Over 200ms Latency for Storage Acct",
          "displayName": "AVD-Storage-Over 200ms Latency for Storage Acct",
          "severity": 2,
          "evaluationFrequency": "PT5M",
          "windowSize": "PT15M",
          "criteria": {
            "allOf": [
              {
                "threshold": 200,
                "name": "Metric1",
                "metricName": "SuccessServerLatency",
                "operator": "GreaterThan",
                "timeAggregation": "Average",
                "criterionType": "StaticThresholdCriterion"
              }
            ],
            "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria"
          },
          "targetResourceType": "Microsoft.Storage/storageAccounts"
        }
      ],
      "fileShares": [
        {
          "name": "AVD-Storage-Possible Throttling Due to High IOPs",
          "displayName": "AVD-Storage-Possible Throttling Due to High IOPs",
          "description": "This indicates you may be maxing out the allowed IOPs.\nhttps://docs.microsoft.com/en-us/azure/storage/files/storage-troubleshooting-files-performance#how-to-create-an-alert-if-a-file-share-is-throttled",
          "severity": 2,
          "evaluationFrequency": "PT5M",
          "windowSize": "PT5M",
          "criteria": {
            "allOf": [
              {
                "threshold": 1,
                "name": "Metric1",
                "metricName": "Transactions",
                "dimensions": [
                  {
                    "name": "ResponseType",
                    "operator": "Include",
                    "values": [
                      "SuccessWithThrottling",
                      "SuccessWithShareIopsThrottling",
                      "ClientShareIopsThrottlingError"
                    ]
                  },
                  {
                    "name": "FileShare",
                    "operator": "Include",
                    "values": [
                      "SuccessWithShareEgressThrottling",
                      "SuccessWithShareIngressThrottling",
                      "SuccessWithShareIopsThrottling",
                      "ClientShareEgressThrottlingError",
                      "ClientShareIngressThrottlingError",
                      "ClientShareIopsThrottlingError"
                    ]
                  }
                ],
                "operator": "GreaterThanOrEqual",
                "timeAggregation": "Total",
                "criterionType": "StaticThresholdCriterion"
              }
            ],
            "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria"
          },
          "targetResourceType": "Microsoft.Storage/storageAccounts/fileServices"
        }
      ],
      "virtualMachines": [
        {
          "name": "AVD-VM-High CPU 85 Percent",
          "displayName": "AVD-VM-High CPU 85 Percent",
          "severity": 2,
          "evaluationFrequency": "PT5M",
          "windowSize": "PT5M",
          "criteria": {
            "allOf": [
              {
                "threshold": 85,
                "name": "Metric1",
                "metricNamespace": "microsoft.compute/virtualmachines",
                "metricName": "Percentage CPU",
                "operator": "GreaterThan",
                "timeAggregation": "Average",
                "criterionType": "StaticThresholdCriterion"
              }
            ],
            "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria"
          },
          "targetResourceType": "microsoft.compute/virtualmachines"
        },
        {
          "name": "AVD-VM-High CPU 95 Percent",
          "displayName": "AVD-VM-High CPU 95 Percent",
          "severity": 1,
          "evaluationFrequency": "PT5M",
          "windowSize": "PT5M",
          "criteria": {
            "allOf": [
              {
                "threshold": 95,
                "name": "Metric1",
                "metricNamespace": "microsoft.compute/virtualmachines",
                "metricName": "Percentage CPU",
                "operator": "GreaterThan",
                "timeAggregation": "Average",
                "criterionType": "StaticThresholdCriterion"
              }
            ],
            "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria"
          },
          "targetResourceType": "microsoft.compute/virtualmachines"
        },
        {
          "name": "AVD-VM-Available Memory Less Than 2GB",
          "displayName": "AVD-VM-Available Memory Less Than 2GB",
          "severity": 2,
          "evaluationFrequency": "PT5M",
          "windowSize": "PT5M",
          "criteria": {
            "allOf": [
              {
                "threshold": 2147483648,
                "name": "Metric1",
                "metricNamespace": "microsoft.compute/virtualmachines",
                "metricName": "Available Memory Bytes",
                "operator": "LessThanOrEqual",
                "timeAggregation": "Average",
                "criterionType": "StaticThresholdCriterion"
              }
            ],
            "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria"
          },
          "targetResourceType": "microsoft.compute/virtualmachines"
        },
        {
          "name": "AVD-VM-Available Memory Less Than 1GB",
          "displayName": "AVD-VM-Available Memory Less Than 1GB",
          "severity": 1,
          "evaluationFrequency": "PT5M",
          "windowSize": "PT5M",
          "criteria": {
            "allOf": [
              {
                "threshold": 1073741824,
                "name": "Metric1",
                "metricNamespace": "microsoft.compute/virtualmachines",
                "metricName": "Available Memory Bytes",
                "operator": "LessThanOrEqual",
                "timeAggregation": "Average",
                "criterionType": "StaticThresholdCriterion"
              }
            ],
            "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria"
          },
          "targetResourceType": "microsoft.compute/virtualmachines"
        }
      ]
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[variables('ResourceGroupName')]",
      "location": "[parameters('Location')]"
    },
    {
      "type": "Microsoft.Authorization/roleDefinitions",
      "apiVersion": "2018-01-01-preview",
      "name": "[guid(variables('RoleName'))]",
      "properties": {
        "roleName": "[variables('RoleName')]",
        "description": "[variables('RoleDescription')]",
        "type": "customRole",
        "permissions": [
          {
            "dataActions": [
              "Microsoft.Insights/Telemetry/Write"
            ]
          }
        ],
        "assignableScopes": [
          "[subscription().id]"
        ]
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2018-09-01-preview",
      "name": "[guid(subscription().id, variables('AutomationAccountName'), 'Reader')]",
      "properties": {
        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'c12c1c16-33a1-487b-954d-41c89c60f349')]",
        "principalId": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupName')), 'Microsoft.Resources/deployments', 'MonitoringResourcesDeployment')).outputs.automationAccountPrincipalId.value]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupName')), 'Microsoft.Resources/deployments', 'MonitoringResourcesDeployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "ds_deployment",
      "resourceGroup": "[variables('ResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "StorageAccountResourceIds": {
            "value": "[parameters('StorageAccountResourceIds')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.7.4.23292",
              "templateHash": "5875430278430079092"
            }
          },
          "parameters": {
            "Location": {
              "type": "string"
            },
            "Timestamp": {
              "type": "string"
            },
            "StorageAccountResourceIds": {
              "type": "array"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "ds-fileServicesResourceIDs",
              "location": "[parameters('Location')]",
              "kind": "AzurePowerShell",
              "properties": {
                "azPowerShellVersion": "5.4",
                "cleanupPreference": "OnSuccess",
                "scriptContent": "      param([array]$StorAcctResIDs)\r\n      $fileServices = @()\r\n      foreach($storacct in $StorAcctResIDs){$fileServices += $storacct + \"/fileServices/default\"}\r\n      $fileServices = $fileServices -replace '[[\\]]',''\r\n      $DeploymentScriptOutputs = @{}\r\n      $DeploymentScriptOutputs[\"fileServicesResourceIDs\"] = $fileServices\r\n    ",
                "arguments": "[format(' -StorAcctResIDs {0}', parameters('StorageAccountResourceIds'))]",
                "forceUpdateTag": "[parameters('Timestamp')]",
                "retentionInterval": "P1D",
                "timeout": "PT30M"
              }
            }
          ],
          "outputs": {
            "fileServicesResourceIDs": {
              "type": "array",
              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', 'ds-fileServicesResourceIDs')).outputs.fileServicesResourceIDs]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "MonitoringResourcesDeployment",
      "resourceGroup": "[variables('ResourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AutomationAccountName": {
            "value": "[variables('AutomationAccountName')]"
          },
          "DistributionGroup": {
            "value": "[parameters('DistributionGroup')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "LogAnalyticsWorkspaceResourceId": {
            "value": "[parameters('LogAnalyticsWorkspaceResourceId')]"
          },
          "LogAlerts": {
            "value": "[variables('LogAlerts')]"
          },
          "LogicAppName": {
            "value": "[variables('LogicAppName')]"
          },
          "MetricAlerts": {
            "value": "[variables('MetricAlerts')]"
          },
          "RunbookName": {
            "value": "[variables('RunbookName')]"
          },
          "RunbookScript": {
            "value": "[variables('RunbookScript')]"
          },
          "ScriptsRepositorySasToken": {
            "value": "[parameters('ScriptsRepositorySasToken')]"
          },
          "ScriptsRepositoryUri": {
            "value": "[parameters('ScriptsRepositoryUri')]"
          },
          "SessionHostsResourceGroupIds": {
            "value": "[parameters('SessionHostsResourceGroupIds')]"
          },
          "StorageAccountResourceIds": {
            "value": "[parameters('StorageAccountResourceIds')]"
          },
          "ActionGroupName": {
            "value": "[variables('ActionGroupName')]"
          },
          "FileServicesResourceIDs": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupName')), 'Microsoft.Resources/deployments', 'ds_deployment')).outputs.fileServicesResourceIDs.value]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.7.4.23292",
              "templateHash": "16662674980280185873"
            }
          },
          "parameters": {
            "ActionGroupName": {
              "type": "string"
            },
            "AutomationAccountName": {
              "type": "string"
            },
            "DistributionGroup": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "LogAnalyticsWorkspaceResourceId": {
              "type": "string"
            },
            "LogAlerts": {
              "type": "array"
            },
            "LogicAppName": {
              "type": "string"
            },
            "MetricAlerts": {
              "type": "object"
            },
            "RunbookName": {
              "type": "string"
            },
            "RunbookScript": {
              "type": "string"
            },
            "ScriptsRepositorySasToken": {
              "type": "secureString"
            },
            "ScriptsRepositoryUri": {
              "type": "string"
            },
            "SessionHostsResourceGroupIds": {
              "type": "array"
            },
            "StorageAccountResourceIds": {
              "type": "array"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string",
              "defaultValue": "[utcNow('u')]"
            },
            "FileServicesResourceIDs": {
              "type": "array"
            }
          },
          "resources": [
            {
              "type": "microsoft.insights/actionGroups",
              "apiVersion": "2019-06-01",
              "name": "[parameters('ActionGroupName')]",
              "location": "global",
              "properties": {
                "groupShortName": "EmailAlerts",
                "enabled": true,
                "emailReceivers": [
                  {
                    "name": "[parameters('DistributionGroup')]",
                    "emailAddress": "[parameters('DistributionGroup')]",
                    "useCommonAlertSchema": true
                  }
                ]
              }
            },
            {
              "copy": {
                "name": "metricAlerts_VirtualMachines",
                "count": "[length(range(0, length(parameters('MetricAlerts').virtualMachines)))]"
              },
              "type": "Microsoft.Insights/metricAlerts",
              "apiVersion": "2018-03-01",
              "name": "[parameters('MetricAlerts').virtualMachines[range(0, length(parameters('MetricAlerts').virtualMachines))[copyIndex()]].name]",
              "location": "global",
              "tags": "[parameters('Tags')]",
              "properties": {
                "severity": "[parameters('MetricAlerts').virtualMachines[range(0, length(parameters('MetricAlerts').virtualMachines))[copyIndex()]].severity]",
                "enabled": false,
                "scopes": "[parameters('SessionHostsResourceGroupIds')]",
                "evaluationFrequency": "[parameters('MetricAlerts').virtualMachines[range(0, length(parameters('MetricAlerts').virtualMachines))[copyIndex()]].evaluationFrequency]",
                "windowSize": "[parameters('MetricAlerts').virtualMachines[range(0, length(parameters('MetricAlerts').virtualMachines))[copyIndex()]].windowSize]",
                "criteria": "[parameters('MetricAlerts').virtualMachines[range(0, length(parameters('MetricAlerts').virtualMachines))[copyIndex()]].criteria]",
                "autoMitigate": false,
                "targetResourceType": "[parameters('MetricAlerts').virtualMachines[range(0, length(parameters('MetricAlerts').virtualMachines))[copyIndex()]].targetResourceType]",
                "targetResourceRegion": "[parameters('Location')]",
                "actions": [
                  {
                    "actionGroupId": "[resourceId('microsoft.insights/actionGroups', parameters('ActionGroupName'))]",
                    "webHookProperties": {}
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('microsoft.insights/actionGroups', parameters('ActionGroupName'))]"
              ]
            },
            {
              "copy": {
                "name": "scheduledQueryRules",
                "count": "[length(range(0, length(parameters('LogAlerts'))))]"
              },
              "type": "Microsoft.Insights/scheduledQueryRules",
              "apiVersion": "2021-08-01",
              "name": "[parameters('LogAlerts')[range(0, length(parameters('LogAlerts')))[copyIndex()]].name]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "actions": {
                  "actionGroups": [
                    "[resourceId('microsoft.insights/actionGroups', parameters('ActionGroupName'))]"
                  ],
                  "customProperties": {}
                },
                "criteria": "[parameters('LogAlerts')[range(0, length(parameters('LogAlerts')))[copyIndex()]].criteria]",
                "displayName": "[parameters('LogAlerts')[range(0, length(parameters('LogAlerts')))[copyIndex()]].displayName]",
                "enabled": false,
                "evaluationFrequency": "[parameters('LogAlerts')[range(0, length(parameters('LogAlerts')))[copyIndex()]].evaluationFrequency]",
                "scopes": [
                  "[parameters('LogAnalyticsWorkspaceResourceId')]"
                ],
                "severity": "[parameters('LogAlerts')[range(0, length(parameters('LogAlerts')))[copyIndex()]].severity]",
                "windowSize": "[parameters('LogAlerts')[range(0, length(parameters('LogAlerts')))[copyIndex()]].windowSize]"
              },
              "dependsOn": [
                "[resourceId('microsoft.insights/actionGroups', parameters('ActionGroupName'))]"
              ]
            },
            {
              "type": "Microsoft.Automation/automationAccounts",
              "apiVersion": "2021-06-22",
              "name": "[parameters('AutomationAccountName')]",
              "location": "[parameters('Location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "sku": {
                  "name": "Free"
                }
              }
            },
            {
              "type": "Microsoft.Automation/automationAccounts/runbooks",
              "apiVersion": "2019-06-01",
              "name": "[format('{0}/{1}', parameters('AutomationAccountName'), parameters('RunbookName'))]",
              "location": "[parameters('Location')]",
              "properties": {
                "runbookType": "PowerShell",
                "logProgress": false,
                "logVerbose": false,
                "publishContentLink": {
                  "uri": "[format('{0}{1}{2}', parameters('ScriptsRepositoryUri'), parameters('RunbookScript'), parameters('ScriptsRepositorySasToken'))]",
                  "version": "1.0.0.0"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', parameters('AutomationAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Automation/automationAccounts/webhooks",
              "apiVersion": "2015-10-31",
              "name": "[format('{0}/{1}', parameters('AutomationAccountName'), format('{0}_{1}', parameters('RunbookName'), dateTimeAdd(parameters('Timestamp'), 'PT0H', 'yyyyMMddhhmmss')))]",
              "properties": {
                "isEnabled": true,
                "expiryTime": "[dateTimeAdd(parameters('Timestamp'), 'P5Y')]",
                "runbook": {
                  "name": "[parameters('RunbookName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', parameters('AutomationAccountName'))]",
                "[resourceId('Microsoft.Automation/automationAccounts/runbooks', parameters('AutomationAccountName'), parameters('RunbookName'))]"
              ]
            },
            {
              "type": "Microsoft.Automation/automationAccounts/variables",
              "apiVersion": "2019-06-01",
              "name": "[format('{0}/{1}', parameters('AutomationAccountName'), format('WebhookURI_{0}', parameters('RunbookName')))]",
              "properties": {
                "value": "[format('\"{0}\"', reference(resourceId('Microsoft.Automation/automationAccounts/webhooks', parameters('AutomationAccountName'), format('{0}_{1}', parameters('RunbookName'), dateTimeAdd(parameters('Timestamp'), 'PT0H', 'yyyyMMddhhmmss')))).uri)]",
                "isEncrypted": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', parameters('AutomationAccountName'))]",
                "[resourceId('Microsoft.Automation/automationAccounts/runbooks', parameters('AutomationAccountName'), parameters('RunbookName'))]",
                "[resourceId('Microsoft.Automation/automationAccounts/webhooks', parameters('AutomationAccountName'), format('{0}_{1}', parameters('RunbookName'), dateTimeAdd(parameters('Timestamp'), 'PT0H', 'yyyyMMddhhmmss')))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('LogAnalyticsWorkspaceResourceId')))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2017-05-01-preview",
              "scope": "[format('Microsoft.Automation/automationAccounts/{0}', parameters('AutomationAccountName'))]",
              "name": "[format('diag-{0}', parameters('AutomationAccountName'))]",
              "properties": {
                "logs": [
                  {
                    "category": "JobLogs",
                    "enabled": true
                  },
                  {
                    "category": "JobStreams",
                    "enabled": true
                  }
                ],
                "workspaceId": "[parameters('LogAnalyticsWorkspaceResourceId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', parameters('AutomationAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2016-06-01",
              "name": "[parameters('LogicAppName')]",
              "location": "[parameters('Location')]",
              "properties": {
                "state": "Enabled",
                "definition": {
                  "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                  "actions": {
                    "HTTP": {
                      "type": "Http",
                      "inputs": {
                        "method": "POST",
                        "uri": "[replace(reference(resourceId('Microsoft.Automation/automationAccounts/variables', parameters('AutomationAccountName'), format('WebhookURI_{0}', parameters('RunbookName')))).value, '\"', '')]",
                        "body": {
                          "StorageAccountResourceIDs": "[parameters('StorageAccountResourceIds')]"
                        }
                      }
                    }
                  },
                  "triggers": {
                    "Recurrence": {
                      "type": "Recurrence",
                      "recurrence": {
                        "frequency": "Minute",
                        "interval": 5
                      }
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts/variables', parameters('AutomationAccountName'), format('WebhookURI_{0}', parameters('RunbookName')))]"
              ]
            },
            {
              "copy": {
                "name": "storAccountMetric",
                "count": "[length(range(0, length(parameters('StorageAccountResourceIds'))))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('MetricAlert_StorageAccount_{0}', range(0, length(parameters('StorageAccountResourceIds')))[copyIndex()])]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "StorageAccountResourceID": {
                    "value": "[parameters('StorageAccountResourceIds')[range(0, length(parameters('StorageAccountResourceIds')))[copyIndex()]]]"
                  },
                  "MetricAlertsStorageAcct": {
                    "value": "[parameters('MetricAlerts').storageAccounts]"
                  },
                  "ActionGroupID": {
                    "value": "[resourceId('microsoft.insights/actionGroups', parameters('ActionGroupName'))]"
                  },
                  "Tags": {
                    "value": "[parameters('Tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.7.4.23292",
                      "templateHash": "18415908559173891209"
                    }
                  },
                  "parameters": {
                    "Location": {
                      "type": "string"
                    },
                    "StorageAccountResourceID": {
                      "type": "string"
                    },
                    "MetricAlertsStorageAcct": {
                      "type": "array"
                    },
                    "ActionGroupID": {
                      "type": "string"
                    },
                    "Tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "metricAlerts_StorageAcct",
                        "count": "[length(range(0, length(parameters('MetricAlertsStorageAcct'))))]"
                      },
                      "type": "Microsoft.Insights/metricAlerts",
                      "apiVersion": "2018-03-01",
                      "name": "[format('{0}-{1}', parameters('MetricAlertsStorageAcct')[range(0, length(parameters('MetricAlertsStorageAcct')))[copyIndex()]].name, split(parameters('StorageAccountResourceID'), '/')[8])]",
                      "location": "global",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "severity": "[parameters('MetricAlertsStorageAcct')[range(0, length(parameters('MetricAlertsStorageAcct')))[copyIndex()]].severity]",
                        "enabled": false,
                        "scopes": [
                          "[parameters('StorageAccountResourceID')]"
                        ],
                        "evaluationFrequency": "[parameters('MetricAlertsStorageAcct')[range(0, length(parameters('MetricAlertsStorageAcct')))[copyIndex()]].evaluationFrequency]",
                        "windowSize": "[parameters('MetricAlertsStorageAcct')[range(0, length(parameters('MetricAlertsStorageAcct')))[copyIndex()]].windowSize]",
                        "criteria": "[parameters('MetricAlertsStorageAcct')[range(0, length(parameters('MetricAlertsStorageAcct')))[copyIndex()]].criteria]",
                        "autoMitigate": false,
                        "targetResourceType": "[parameters('MetricAlertsStorageAcct')[range(0, length(parameters('MetricAlertsStorageAcct')))[copyIndex()]].targetResourceType]",
                        "targetResourceRegion": "[parameters('Location')]",
                        "actions": [
                          {
                            "actionGroupId": "[parameters('ActionGroupID')]"
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('microsoft.insights/actionGroups', parameters('ActionGroupName'))]"
              ]
            },
            {
              "copy": {
                "name": "fileServicesMetric",
                "count": "[length(range(0, length(parameters('FileServicesResourceIDs'))))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('MetricAlert_FileServices_{0}', range(0, length(parameters('FileServicesResourceIDs')))[copyIndex()])]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "FileServicesResourceID": {
                    "value": "[parameters('FileServicesResourceIDs')[range(0, length(parameters('FileServicesResourceIDs')))[copyIndex()]]]"
                  },
                  "MetricAlertsFileShares": {
                    "value": "[parameters('MetricAlerts').fileShares]"
                  },
                  "ActionGroupID": {
                    "value": "[resourceId('microsoft.insights/actionGroups', parameters('ActionGroupName'))]"
                  },
                  "Tags": {
                    "value": "[parameters('Tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.7.4.23292",
                      "templateHash": "15383822911911898535"
                    }
                  },
                  "parameters": {
                    "Location": {
                      "type": "string"
                    },
                    "FileServicesResourceID": {
                      "type": "string"
                    },
                    "MetricAlertsFileShares": {
                      "type": "array"
                    },
                    "ActionGroupID": {
                      "type": "string"
                    },
                    "Tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "metricAlerts_FileShares",
                        "count": "[length(range(0, length(parameters('MetricAlertsFileShares'))))]"
                      },
                      "type": "Microsoft.Insights/metricAlerts",
                      "apiVersion": "2018-03-01",
                      "name": "[format('{0}-{1}', parameters('MetricAlertsFileShares')[range(0, length(parameters('MetricAlertsFileShares')))[copyIndex()]].name, split(parameters('FileServicesResourceID'), '/')[8])]",
                      "location": "global",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "severity": "[parameters('MetricAlertsFileShares')[range(0, length(parameters('MetricAlertsFileShares')))[copyIndex()]].severity]",
                        "enabled": false,
                        "scopes": [
                          "[parameters('FileServicesResourceID')]"
                        ],
                        "evaluationFrequency": "[parameters('MetricAlertsFileShares')[range(0, length(parameters('MetricAlertsFileShares')))[copyIndex()]].evaluationFrequency]",
                        "windowSize": "[parameters('MetricAlertsFileShares')[range(0, length(parameters('MetricAlertsFileShares')))[copyIndex()]].windowSize]",
                        "criteria": "[parameters('MetricAlertsFileShares')[range(0, length(parameters('MetricAlertsFileShares')))[copyIndex()]].criteria]",
                        "autoMitigate": false,
                        "targetResourceType": "[parameters('MetricAlertsFileShares')[range(0, length(parameters('MetricAlertsFileShares')))[copyIndex()]].targetResourceType]",
                        "targetResourceRegion": "[parameters('Location')]",
                        "actions": [
                          {
                            "actionGroupId": "[parameters('ActionGroupID')]"
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('microsoft.insights/actionGroups', parameters('ActionGroupName'))]"
              ]
            }
          ],
          "outputs": {
            "automationAccountPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Automation/automationAccounts', parameters('AutomationAccountName')), '2021-06-22', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupName')), 'Microsoft.Resources/deployments', 'ds_deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('ResourceGroupName'))]"
      ]
    }
  ]
}